<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebSocket Song Player</title>
</head>
<body>
    <h1>WebSocket Song Player</h1>
    <ul id="songList"></ul>
    <audio id="audioPlayer" controls></audio>

    <script>
        const socket = new WebSocket('ws://192.168.1.9:443'); // Update with your server's address

        socket.addEventListener('open', (event) => {
            console.log('WebSocket connection opened');
        });

        socket.addEventListener('message', (event) => {
            const data = JSON.parse(event.data);

            if (data.type === 'songList') {
                displaySongList(data.data);
            }
            if (data.type == 'selectedSong'){
                playSongFromServer(data);
            }
        });

        socket.addEventListener('close', (event) => {
            console.log('WebSocket connection closed');
        });

        function displaySongList(songList) {
            const songListContainer = document.getElementById('songList');

            songList.forEach((song) => {
                const listItem = document.createElement('li');
                listItem.textContent = song;
                listItem.onclick = () => {
                    sendPlaySongMessage(song);
                };
                songListContainer.appendChild(listItem);
            });
        }

        function playSongFromServer(song) {
            // const byteCharacters = atob(song.audioData);
            // const byteNumbers = new Array(byteCharacters.length);
            // for (let i = 0; i < byteCharacters.length; i++) {
            //     byteNumbers[i] = byteCharacters.charCodeAt(i);
            // }

            // const byteArray = new Uint8Array(byteNumbers);
            // const blob = new Blob([byteArray], { type: 'audio/mp3' }); // Adjust the type accordingly
            console.log(song.audioData)
            const audioUrl = atob(song.audioData)
            console.log(audioUrl)
            
            console.log(`Song ${song.selectedSong} not found in local cache. Downloading...`);
            localStorage.setItem(song.selectedSong, audioUrl);
            console.log(audioUrl)
            console.log('Playing song:', song.selectedSong);
            const audioPlayer = document.getElementById('audioPlayer');
            // const audioData = audioUrl; // Assuming audioData is a base64-encoded audio file
            audioPlayer.src = audioUrl;
            // audioPlayer.src = `data:audio/mp3;base64,${audioData}`;
            audioPlayer.play();
        }

        function playSongFromCache(audioUrl, song) {
            console.log(`Playing song ${song} from local cache.`);
            const audioPlayer = document.getElementById('audioPlayer');
            // const audioData = audioUrl; // Assuming audioData is a base64-encoded audio file

            // Create a Blob from the data
            var fileReader = new FileReader();
            fileReader.onload = function (event) {
                // event.target.result contains the binary data as a base64-encoded string
                console.log("Audio data as base64:", event.target.result);
                audioPlayer.src = event.target.result;
            };
            // Read the Blob
            fileReader.readAsDataURL(new Blob([audioUrl], { type: 'audio/mp3' }));
            // Create a new Blob URL
            

            // audioPlayer.src = audioBlobUrl;
            audioPlayer.play();
        }

        function sendPlaySongMessage(song) {
            console.log(song)
            const audioUrl = localStorage.getItem(song);
            console.log(audioUrl);
            if(audioUrl){
                playSongFromCache(audioUrl, song);
            }
            else{
                const message = JSON.stringify({ type: 'playSong', data: song });
                socket.send(message);
            } 
        }
    </script>
</body>
</html>
